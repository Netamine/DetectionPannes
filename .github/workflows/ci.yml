name: CI/CD Pipeline

on:
  push:
    branches:
      - amine
      - dev
      - main
  pull_request:
    branches:
      - dev
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du repo
        uses: actions/checkout@v4

      - name: ğŸ”§ Installer Python et les dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[gdrive] pytest

      - name: ğŸ”‘ Configurer Google Drive Credentials
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS" > gdrive-creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gdrive-creds.json
          dvc remote modify dvc_data gdrive_service_account_json_file_path gdrive-creds.json
          dvc remote modify dvc_data gdrive_use_service_account true

      - name: â¬‡ï¸ TÃ©lÃ©charger les donnÃ©es avec DVC
        run: dvc pull
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $PWD/gdrive-creds.json

      - name: ğŸƒ ExÃ©cuter les tests
        run: pytest tests/

  docker:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du repo
        uses: actions/checkout@v4

      - name: ğŸ”§ Installer Docker CLI
        run: sudo apt-get install -y docker.io

      - name: ğŸ”‘ Se connecter Ã  Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ—ï¸ Build et push de lâ€™image Docker
        run: |
          docker build -t monrepo/monimage:latest .
          docker tag monrepo/monimage:latest monrepo/monimage:$(date +%Y%m%d%H%M)
          docker push monrepo/monimage:latest
          docker push monrepo/monimage:$(date +%Y%m%d%H%M)
