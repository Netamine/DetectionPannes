name: CI/CD Pipeline

on:
  push:
    branches:
      - amine
      - dev
      - main
  pull_request:
    branches:
      - dev
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout du repo
        uses: actions/checkout@v4

      - name: 🔧 Installer Python et les dépendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[gdrive] pytest

      - name: 🔑 Configurer Google Drive Credentials
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS" > gdrive-creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gdrive-creds.json
          dvc remote modify dvc_data gdrive_service_account_json_file_path gdrive-creds.json
          dvc remote modify dvc_data gdrive_use_service_account true

      - name: ⬇️ Télécharger les données avec DVC
        run: dvc pull
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $PWD/gdrive-creds.json

      - name: 🏃 Exécuter les tests
        run: pytest tests/

  docker:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout du repo
        uses: actions/checkout@v4

      - name: 🔧 Installer Docker CLI
        run: sudo apt-get install -y docker.io

      - name: 🔑 Se connecter à Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: 🏗️ Build et push de l’image Docker
        run: |
          docker build -t monrepo/monimage:latest .
          docker tag monrepo/monimage:latest monrepo/monimage:$(date +%Y%m%d%H%M)
          docker push monrepo/monimage:latest
          docker push monrepo/monimage:$(date +%Y%m%d%H%M)
