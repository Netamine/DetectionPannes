# Utiliser une image l√©g√®re de Python
FROM python:3.11-slim

# D√©finir le r√©pertoire de travail
WORKDIR /app

# D√©sactiver CUDA (si besoin)
ENV CUDA_VISIBLE_DEVICES=""

# Installer Tini pour la gestion des processus
RUN apt-get update && apt-get install -y tini && apt-get clean && rm -rf /var/lib/apt/lists/*

# D√©finir l'entr√©e de commande avec Tini
ENTRYPOINT ["/usr/bin/tini", "--"]

# Installer les d√©pendances syst√®me et DVC
RUN apt-get update && apt-get install -y \
    git \
    wget \
    && pip install --no-cache-dir dvc[gdrive] \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Copier le fichier des d√©pendances et les installer
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# Assurer que Flasgger (Swagger pour Flask) est bien install√©
RUN pip install --no-cache-dir flasgger

# Copier `run.py`
COPY run.py /app/run.py

# Copier la cl√© d'authentification Google Drive
COPY keys/CleDVCJason.json /root/.config/dvc/CleDVCJason.json

# Copier uniquement le backend dans `/app/backend`
COPY backend /app/backend

# Copier uniquement le frontend dans `/app/frontend`
COPY frontend /app/frontend

# D√©finir la variable d‚Äôenvironnement pour DVC
ENV GDRIVE_CREDENTIALS_DATA="/root/.config/dvc/CleDVCJason.json"

# Initialiser DVC et configurer le remote Google Drive
RUN dvc init --no-scm && \
    dvc remote add -d dvc_data gdrive://1G3bpMF46owL-_Z1mnEtmrJ_61nWQlRfO && \
    dvc remote modify dvc_data gdrive_use_service_account true && \
    dvc remote modify dvc_data gdrive_service_account_json_file_path /root/.config/dvc/CleDVCJason.json

# V√©rifier si les mod√®les existent, sinon les r√©cup√©rer
RUN if [ ! -d "data/models" ] || [ -z "$(ls -A data/models)" ]; then \
        echo "üìå Mod√®les absents, r√©cup√©ration avec DVC..."; \
        dvc pull && rm -rf .dvc/tmp; \
    else \
        echo "‚úÖ Mod√®les d√©j√† pr√©sents, pas de r√©cup√©ration n√©cessaire."; \
    fi

# Nettoyer les fichiers temporaires inutiles
RUN rm -rf .dvc/tmp

# Exposer les ports pour Flask et Streamlit
EXPOSE 5000 8501

# Lancer le script de d√©marrage
CMD ["python", "/app/run.py"]
